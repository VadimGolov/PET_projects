## Обновление и установка Plugins для PyCharm v1.0 Техническое описание

### Описание проекта и использованных технологий

Проект имеет модульную структуру, каждый модуль работает с соответствующим содержимым:
с базой данный, с файлами, c web, запуск VPN, Дополнительные классы для интерфейса.


- Графический интерфейс выполнен на основе библиотеки tkinter ttk тема clam. Виджеты
entry и checkbutton реализованы на базе tk.Entry и tk.Checkbutton поскольку не могли быть
полностью стилизованы с помощью ttk;
- Работа с базой данных SQLite осуществляется через sqlite3;
- Работа с файловой системой осуществляется с помощью pathlib Path;
- Поиск ссылок для скачивания plugin'ов осуществляется с помощью библиотеки Selenium;
- Поиск и скачивание файлов осуществляется с помощью библиотеки requests c параметром stream=True, по фрагментам;
- Работа с VPN осуществляется с помощью библиотеки subprocess, закрытие окна с рекламой с помощью pyautogui.

---

### Структура проекта

```text
project_root/
├── Update_GUI.pyw      # Точка входа, интерфейс
│
├── database/
│   └── plugins.db.py   # База данных
├── image/              # Изображения для интерфейса
│   ├── header.png
│   ├── icon.ico
│   └── logo.png
├── plugins/            # Скачанные плагины
│   └── unpacked/       # Распакованные плагины
├── psiphon/
│   └── Psiphon_3.exe   # Файл запуска VPN
│
├── db_handler.py       # Работа с базой данных
├── files_hadler.py     # Работа с файлами
├── web_handler.py      # Работа с selenum
├── vpn_launcher.py     # Запуск VPN, проверка соединения
├── gui_support.py      # Дополнительные классы для интерфейса
├── README.md           # Инструкция
├── TO.md               # Техническое описание
└── requirements.txt    # Список модулей для импорта
```
Я поясню только то что может быть непонятно в схеме.

- Папка `plugins/` - сюда скачиваются плагины (обычно файлы в формате .zip);
- Папка `unpacked/` - сюда распаковываются плагины после скачивания (плагины в формате .jar сразу скачиваются в эту папку).


- Файл `gui_support.py` - в этом файле находятся классы, **SafeWidgetPatcher, ThreadTaskManager, dataclass GuiContext, dataclass Args,** и функция **resource_path**;
  - `SafeWidgetPatcher` - monkey-patch на параметры .config() виджетов ttk.Label и ttk.Progressbar обновление 
  интерфейса всегда в главном потоке;
  - `ThreadTaskManager` - менеджер задач для организации фонового потока и работы с ним, это обеспечивает отзывчивость интерфейса;
  - `dataclass GuiContext` - контекст приложения Update Plugins, используется для хранения данных и состояний, связанных с GUI и логикой;
  - `dataclass Args` - аргументы, используется для хранения и предачи в функции параметров VPN и папки PyCharm;
  - `resource_path` - функция для получения абсолютного пути к ресурсам в скомпилированном exe;
  
---

### Дополнительные технологии

Кроме основных библиотек, проект использует: 
queue и threading для работы с дополнительными потоками.

Для того чтобы интерфейс на tkinter сохранял отзывчивость даже при выполнении долгих операции,
проект использует библиотеку `threading` и `queue` для работы с дополнительными потоками. Дополнительный
поток управляется менеджером задач `ThreadTaskManager`, и всегда работает в фоне. При закрытии приложения
дополнительный поток тоже завершается.

Поскольку проект организует дополнительный поток, а виджеты tkinter должны обновляться в главном потоке,
пришлось использовать класс `SafeWidgetPatcher` это monkey-patch на параметры .config() виджетов
ttk.Label и ttk.Progressbar. Экземпляр класса проверяет, выполняется ли код обновления интерфейса в главном потоке.
Если код выполняется в главном потоке, то он запускается без модификации, иначе с помощью widget.after.

---

### Логика работы, ответы на вопросы

Программы имеет 2 основных режима работы:
* Режим скачивания плагинов;
* Режим установки плагинов;
* Скачивание и установка, это комбинация этих двух режимов с некоторыми изменениями;

>**Скачивание**: В данном режиме программа проверяет что VPN активен. Затем проверяется наличие отмеченных plugin'ов, и формируются:
список словарей с данными о плагинах, список индикаторов прогресса, список текстовых меток для вывода информации. Потом программа 
очищает папку с plugin'ами (project_root/plugins) — удаляются все файлы скачанные более суток назад. Затем удаляется всё содержимое 
папки (project_root/plugins/unpacked). После этого запускается selenuim в скрытом режиме и ищет ссылки для скачивания последних версий 
plugin'ов на страницах маркета JetBrains. Для каждого plugin'а программа находит url для скачивания, имя файла и его размер. 
Следующим этапом plugin'ы скачиваются по частям, чтобы обеспечить визуализацию процесса. При сохранении программа проверяет, 
не скачан ли уже этот файл. Если такой файл существует, то индикатор прогресса устанавливается на 100% и программа переходит 
к следующему plugin'у, недостающие файлы скачиваются. Данные об именах скачанных файлов записываются в базу данных (БД).

**- Вопрос**: Почему программа проверяет наличие уже скачанного файла? Информация из БД получена еще до открытия основного окна, 
так не проще ли сразу проверить, имеются ли на диске файлы с именами, указанными в БД и сократить список? Это было бы гораздо быстрее.  
**- Ответ**: _Первый аспект_: Актуальность данных — скачали файлы, записали в БД имена файлов. При следующем запуске решили установить - 
в БД актуальная информация.  
_Второй аспект_: Возможно, производитель изменил название plugin'а и имя файла - информация в БД стала неактуальной. При скачивании
программа сравнивает найденные имена с имеющимися на диске. Если совпадений нет скачивает файл, а потом новые данные записывает в БД.  
_Третий аспект_: При добавлении в БД нового plugin'а, имя файла еще неизвестно. Поэтому важно его найти и записать имя в БД.  
Да, это медленный способ, но вполне обоснованный.

>**Установка**: В этом режиме сначала проверяется задан ли путь к папке PyCharm на системном диске. Далее программа проверяет папку с
plugin'ами (project_root/plugins) и определяет какие плагины скачаны. Как правило, plugin'ы поставляются в виде пакета файлов в zip-архиве, 
реже как один jar-файл. Программа распаковывает zip-архивы и записывает их в папку project_root/plugins/unpacked, jar-файлы копируются 
туда еще при скачивании. Потом программа записывает в БД имена папок с распакованными plugin'ами — теперь в БД есть вся необходимая информация.
На основании списка имён папок с распакованными plugin'ами формируется список папок для удаления. Программа удаляет папки из списка в
папке PyCharm на системном диске. Далее копирует туда папки с распакованными plugin'ами. 

**- Вопрос**: У меня уже установлены plugin'ы которых нет в программе, они продолжат работать после **Обновление и установка Plugins для PyCharm v1.0**   
**- Ответ**: Да другие plugin'ы будут работать. Программа лишь обновит или установит plugin'ы из своего списка.  
**- Вопрос**: Для чего программа записывает в БД имена файлов с plugin'ами и имена папок с распакованными plugin'ами. Ведь все работает и без этих записей?  
**- Ответ**: Это делается для связи GUI c действиями программы. Кроме того, список папок для удаления, составляется на основании списка папок из БД.
 
>**Скачивание и установка**: Скачивание поизводится по уже описанному алгоритму. При установке программа не проверяет папку с plugin'ами (project_root/plugins).
Распаковываются и устанавливаются только отмеченные plugin'ы.    

---

### Список модулей использованных в проекте

* dataclasses  
* datetime     
* pathlib 
* pyautogui    
* pygetwindow  
* queue
* re      
* requests
* selenium
* shutil  
* sqlite3
* subprocess
* sys
* threading 
* tkinter   
* ttk       
* typing    
* zipfile